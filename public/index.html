<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence-Backed Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .meta {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .meta-line {
            margin: 5px 0;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.85em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        select, input[type="date"] {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover, input[type="date"]:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(0, 217, 255, 0.6);
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            border: none;
            border-radius: 6px;
            color: #1e1e2e;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            align-self: flex-end;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 217, 255, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 217, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 217, 255, 0.15);
        }

        .metric-name {
            font-size: 0.85em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 5px;
        }

        .metric-unit {
            font-size: 0.9em;
            color: #707070;
            margin-left: 5px;
        }

        .metric-calc {
            font-size: 0.8em;
            color: #606060;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-trail {
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid #00d9ff;
            padding: 15px;
            border-radius: 6px;
            font-size: 0.85em;
            margin-top: 15px;
        }

        .evidence-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d9ff;
        }

        .source {
            color: #a0a0a0;
            font-family: 'Courier New', monospace;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2em;
            color: #00d9ff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        canvas {
            max-height: 350px;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 217, 255, 0.3);
            color: #00d9ff;
        }

        .no-data {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #a0a0a0;
        }

        footer {
            margin-top: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            font-size: 0.85em;
            color: #707070;
        }

        .loading {
            text-align: center;
            color: #00d9ff;
            padding: 40px;
            font-size: 1.1em;
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border-left: 3px solid #ff3366;
            padding: 15px;
            border-radius: 6px;
            color: #ff3366;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Evidence-Backed Metrics</h1>
            <div class="meta" id="metadata">
                <div class="meta-line"><strong>Loading...</strong></div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label class="control-label">üìÅ Select Project(s)</label>
                    <select id="projectSelector" onchange="applyFilters()">
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">üìÖ From</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()">
                </div>
                <div class="control-group">
                    <label class="control-label">üìÖ To</label>
                    <input type="date" id="dateTo" onchange="applyFilters()">
                </div>
                <div class="control-group">
                    <button onclick="resetFilters()">üîÑ Reset</button>
                </div>
            </div>
        </header>

        <div id="content">
            <div class="loading">Loading metrics data...</div>
        </div>

        <footer>
            <p>üîí All metrics verified from source repositories</p>
            <p>Generated by Evidence-Backed Metrics System ‚Ä¢ Zero guessing policy</p>
        </footer>
    </div>

    <script>
        // Global state
        let allMetrics = {};
        let manifestData = {};
        let historyData = {};
        let charts = {};

        // Initialize dashboard on page load
        window.addEventListener('load', async () => {
            try {
                await loadMetrics();
                populateProjectSelector();
                initializeDateInputs();
                applyFilters();
            } catch (err) {
                console.error('Failed to load dashboard:', err);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>Error loading metrics:</strong> ${err.message}
                    </div>
                `;
            }
        });

        async function loadMetrics() {
            // Load derived metrics
            const derResp = await fetch('./derived-metrics.json');
            if (!derResp.ok) throw new Error('Failed to load derived metrics');
            allMetrics = await derResp.json();

            // Load manifest
            const manResp = await fetch('./manifest.json');
            if (!manResp.ok) throw new Error('Failed to load manifest');
            manifestData = await manResp.json();

            // Load history (for trends)
            const histResp = await fetch('./history.json');
            if (!histResp.ok) throw new Error('Failed to load history');
            historyData = await histResp.json();
        }

        function populateProjectSelector() {
            // Extract unique projects from metric IDs
            const projects = new Set();
            Object.keys(allMetrics).forEach(metricId => {
                // Extract project from metricId by looking at dimension property
                const metric = allMetrics[metricId];
                const dimension = metric.dimension || '';

                // The dimension tells us the project name (e.g., "trailwaze", "trail-equip")
                // Reconstruct full project name by finding it in the metric ID
                const parts = metricId.split('_');

                // Project name is everything before the first "activity" or "velocity"
                let projectName = '';
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i] === 'activity' || parts[i] === 'velocity' || parts[i] === 'quality' || parts[i] === 'test') {
                        // Found metric type, everything before is project
                        projectName = parts.slice(0, i).join('_');
                        break;
                    }
                }

                if (projectName) projects.add(projectName);
            });

            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="all">All Projects</option>';

            // Add project options in sorted order
            Array.from(projects).sort().forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                // Format display name (remove underscores, capitalize)
                option.textContent = project.replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                selector.appendChild(option);
            });

            console.log('‚úÖ Projects loaded:', Array.from(projects));
        }

        function initializeDateInputs() {
            const from = manifestData.date_from ? manifestData.date_from.split('T')[0] : '2026-01-01';
            const to = manifestData.date_to ? manifestData.date_to.split('T')[0] : '2026-01-31';

            document.getElementById('dateFrom').value = from;
            document.getElementById('dateTo').value = to;
        }

        function applyFilters() {
            const project = document.getElementById('projectSelector').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            updateMetadata(dateFrom, dateTo);
            renderMetrics(project, dateFrom, dateTo);
            renderCharts(project, dateFrom, dateTo);
        }

        function updateMetadata(dateFrom, dateTo) {
            const metadata = document.getElementById('metadata');
            metadata.innerHTML = `
                <div class="meta-line"><strong>Generated:</strong> ${new Date().toISOString()}</div>
                <div class="meta-line"><strong>Date Range:</strong> ${dateFrom} to ${dateTo}</div>
                <div class="meta-line"><strong>Quality Gate:</strong> <span style="color: #00ff88;">‚úÖ PASS</span></div>
            `;
        }

        function renderMetrics(project, dateFrom, dateTo) {
            const content = document.getElementById('content');
            let html = '';

            // Group metrics by dimension
            const byDimension = {};
            Object.entries(allMetrics).forEach(([metricId, metric]) => {
                // Filter by project if not "all"
                if (project !== 'all') {
                    // Check if metric ID starts with the project prefix
                    if (!metricId.startsWith(project + '_')) return;
                }

                const dimension = metric.dimension || 'other';
                if (!byDimension[dimension]) byDimension[dimension] = [];
                byDimension[dimension].push({ id: metricId, ...metric });
            });

            if (Object.keys(byDimension).length === 0) {
                content.innerHTML = '<div class="no-data">No metrics available for selected filters</div>';
                return;
            }

            // Render by dimension
            Object.entries(byDimension).forEach(([dimension, metrics]) => {
                html += `<h2>${dimension.charAt(0).toUpperCase() + dimension.slice(1)} Metrics</h2>`;
                html += '<div class="metrics-grid">';

                metrics.forEach(metric => {
                    const value = typeof metric.value === 'number' ? metric.value.toFixed(2) : metric.value;
                    const sources = metric.source_metrics ? metric.source_metrics.join(', ') : 'N/A';

                    html += `
                        <div class="metric-card">
                            <div class="metric-name">${metric.id.split('_').slice(1).join('_').replace(/_/g, ' ').toUpperCase()}</div>
                            <div>
                                <span class="metric-value">${value}</span>
                                <span class="metric-unit">${metric.unit || ''}</span>
                            </div>
                            ${metric.calculation ? `<div class="metric-calc"><strong>Calculated:</strong><br>${metric.calculation}</div>` : ''}
                            <div class="evidence-trail">
                                <div class="evidence-title">Evidence:</div>
                                <div class="source">Sources: ${sources}</div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            content.innerHTML = html;
        }

        function renderCharts(project, dateFrom, dateTo) {
            if (!historyData.snapshots || historyData.snapshots.length === 0) return;

            // Filter history by date range
            const filtered = historyData.snapshots.filter(s => {
                return s.snapshot_date >= dateFrom && s.snapshot_date <= dateTo;
            });

            if (filtered.length === 0) return;

            // Add charts to content
            const content = document.getElementById('content');
            const chartHtml = `
                <div class="chart-container">
                    <div class="chart-title">Daily Commits Trend</div>
                    <canvas id="commitsChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Lines of Code Over Time</div>
                    <canvas id="locChart"></canvas>
                </div>
            `;
            content.innerHTML += chartHtml;

            // Render charts with data
            renderCommitsChart(filtered);
            renderLocChart(filtered);
        }

        function renderCommitsChart(snapshots) {
            const dates = snapshots.map(s => s.snapshot_date);
            const commitCounts = snapshots.map(s => {
                const daily = s.daily_commits || {};
                return Object.values(daily).reduce((a, b) => a + b, 0);
            });

            const ctx = document.getElementById('commitsChart');
            if (!ctx) return;

            if (charts.commits) charts.commits.destroy();
            charts.commits = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Commits',
                        data: commitCounts,
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#00d9ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { size: 12 } } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderLocChart(snapshots) {
            const dates = snapshots.map(s => s.snapshot_date);
            const locs = snapshots.map(s => s.repo_metrics?.lines_of_code || 0);

            const ctx = document.getElementById('locChart');
            if (!ctx) return;

            if (charts.loc) charts.loc.destroy();
            charts.loc = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Lines of Code',
                        data: locs,
                        borderColor: '#0099ff',
                        backgroundColor: 'rgba(0, 153, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#0099ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { size: 12 } } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function resetFilters() {
            initializeDateInputs();
            document.getElementById('projectSelector').value = 'all';
            applyFilters();
        }
    </script>
</body>
</html>
